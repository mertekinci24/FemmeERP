<Window x:Class="InventoryERP.Presentation.Views.ItemEditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:InventoryERP.Presentation.Converters"
        xmlns:behaviors="clr-namespace:InventoryERP.Presentation.Behaviors"
        Title="Stok Kartı Düzenle" Width="800" Height="600"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <!-- R-044: Add ESC key binding for Cancel command -->
    <Window.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCmd}"/>
    </Window.InputBindings>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:NullToBooleanConverter x:Key="NullToBooleanConverter"/>
    </Window.Resources>
    
    <DockPanel Margin="16">
        <!-- R-040: Item Edit Dialog with 3 tabs: Basic Info, Multi-UOM, Warehouse Stock -->
        
        <!-- Bottom Buttons -->
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Bottom" HorizontalAlignment="Right" Margin="0,16,0,0">
            <Button Content="💾 Kaydet" Command="{Binding SaveCmd}" Width="120" Margin="0,0,8,0" IsDefault="True"/>
            <Button Content="❌ İptal" Command="{Binding CancelCmd}" Width="120" IsCancel="True"/>
        </StackPanel>

        <!-- Tabs -->
        <TabControl>
            <!-- Tab 1: Basic Info -->
            <TabItem Header="📋 Temel Bilgiler">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="16">
                        <TextBlock Text="Stok Kartı Temel Bilgileri" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,16"/>

                        <!-- SKU -->
                        <Label Content="SKU (Stok Kodu) *" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding Sku, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,12"/>

                        <!-- Barcode -->
                        <Label Content="Barkod" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                            <TextBox Text="{Binding Barcode, UpdateSourceTrigger=PropertyChanged}" Width="220"
                                     ToolTip="69 ile baslayan 13 haneli barkod girin veya Olustur tusuna basin."/>
                            <Button Content="Oluştur" Command="{Binding GenerateBarcodeCmd}" Margin="8,0,0,0" Width="90"
                                    ToolTip="Boşsa benzersiz barkod üretir."/>
                        </StackPanel>

                        <!-- Name -->
                        <Label Content="Ürün Adı *" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,12"/>

                        <!-- Category -->
                        <Label Content="Kategori" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding Category, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,12"/>

                        <!-- R-289: Brand (Marka) -->
                        <Label Content="Marka" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding Brand, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,12"/>

                        <!-- Base UOM -->
                        <Label Content="Ana Birim *" FontWeight="SemiBold"/>
                        <!-- R-051: Replace TextBox with ComboBox for Turkish UOM names -->
                        <ComboBox ItemsSource="{Binding BaseUomOptions}"
                                  SelectedItem="{Binding BaseUom, UpdateSourceTrigger=PropertyChanged}"
                                  ToolTip="Ölçü birimi seçiniz (ADET, KG, KOLI, vb.)"
                                  IsEditable="False"
                                  Margin="0,0,0,12"/>

                        <!-- VAT Rate -->
                        <Label Content="KDV Oranı (%) *" FontWeight="SemiBold"/>
                        <ComboBox SelectedItem="{Binding VatRate}" Margin="0,0,0,12">
                            <ComboBoxItem Content="1" Tag="1"/>
                            <ComboBoxItem Content="10" Tag="10"/>
                            <ComboBoxItem Content="20" Tag="20" IsSelected="True"/>
                        </ComboBox>

                        <!-- R-228: Cost (Maliyet) -->
                        <Label Content="Maliyet (Birim Maliyeti)" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding Cost, UpdateSourceTrigger=PropertyChanged, StringFormat='N2'}" 
                                 behaviors:TextBoxBehavior.SelectAllOnFocus="True"
                                 Margin="0,0,0,12"
                                 ToolTip="Ürünün birim maliyeti (TL)"/>

                        <!-- R-234: Sales Price (Satış Fiyatı) -->
                        <Label Content="Satış Fiyatı" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding SalesPrice, UpdateSourceTrigger=PropertyChanged, StringFormat='N2'}" 
                                 behaviors:TextBoxBehavior.SelectAllOnFocus="True"
                                 Margin="0,0,0,12"
                                 ToolTip="Faturada otomatik fiyat (TL)"/>

                        <!-- Active -->
                        <CheckBox Content="Aktif" IsChecked="{Binding Active}" Margin="0,0,0,12"/>

                        <!-- R-230: Stock Quantity - Read-Only for existing products -->
                        <Label FontWeight="SemiBold" ToolTip="Yeni ürün için açılış stok miktarı, düzenlemede salt okunur">
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="Content" Value="Başlangıç Stok Miktarı"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                            <Setter Property="Content" Value="Mevcut Stok (Salt Okunur)"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Label.Style>
                        </Label>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                            <TextBox Text="{Binding CurrentStock, UpdateSourceTrigger=PropertyChanged, StringFormat='N2'}" 
                                     behaviors:TextBoxBehavior.SelectAllOnFocus="True"
                                     Width="120" Margin="0,0,8,0"
                                     IsReadOnly="{Binding IsEditMode}"
                                     ToolTip="Düzenleme modunda salt okunur"/>
                        </StackPanel>

                        <!-- R-210: Default Warehouse/Location -->
                        <Label Content="Varsayılan Depo / Konum" FontWeight="SemiBold" ToolTip="Belgelerde otomatik seçilecek depo ve konum"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                            <ComboBox ItemsSource="{Binding Warehouses}"
                                      SelectedValue="{Binding DefaultWarehouseId}"
                                      SelectedValuePath="Id"
                                      DisplayMemberPath="Name"
                                      Width="180" Margin="0,0,8,0"
                                      ToolTip="Varsayılan Depo"/>
                            
                            <ComboBox ItemsSource="{Binding Locations}"
                                      SelectedValue="{Binding DefaultLocationId}"
                                      SelectedValuePath="Id"
                                      DisplayMemberPath="Code"
                                      Width="150"
                                      ToolTip="Varsayılan Konum"
                                      IsEnabled="{Binding DefaultWarehouseId, Converter={StaticResource NullToBooleanConverter}}"/>
                        </StackPanel>

                        <TextBlock Text="* Zorunlu alanlar" FontStyle="Italic" Opacity="0.7" Margin="0,8,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Tab 2: Multi-UOM Management (R-029) -->
            <TabItem Header="📦 Çoklu Birim">
                <DockPanel Margin="16">
                    <TextBlock DockPanel.Dock="Top" Text="Çoklu Birim Tanımları (R-029: Multi-UOM)" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    
                    <!-- Add UOM Section -->
                    <GroupBox Header="Yeni Birim Ekle" DockPanel.Dock="Top" Margin="0,0,0,16">
                        <Grid Margin="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Label Grid.Row="0" Grid.Column="0" Content="Birim Adı" FontWeight="SemiBold"/>
                            <TextBox Grid.Row="1" Grid.Column="0" Text="{Binding NewUomName, UpdateSourceTrigger=PropertyChanged}" 
                                     ToolTip="Örn: KOLI, PALET, KUTU" Margin="0,0,8,0"/>

                            <Label Grid.Row="0" Grid.Column="1" Content="Katsayı" FontWeight="SemiBold"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding NewUomCoefficient, UpdateSourceTrigger=PropertyChanged}" 
                                     ToolTip="Ana birime göre çarpan (örn: 1 KOLI = 12 EA)" Margin="0,0,8,0"/>

                            <Button Grid.Row="1" Grid.Column="2" Content="➕ Ekle" Command="{Binding AddUomCmd}" Width="80" Height="24"/>
                        </Grid>
                    </GroupBox>

                    <!-- UOM List -->
                    <DataGrid ItemsSource="{Binding UomList}" AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" CanUserDeleteRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Birim Adı" Binding="{Binding UomName}" Width="*"/>
                            <DataGridTextColumn Header="Katsayı" Binding="{Binding Coefficient, StringFormat='{}{0:N2}'}" Width="*"/>
                            <DataGridTemplateColumn Header="İşlem" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="🗑️ Sil" Command="{Binding DataContext.RemoveUomCmd, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}" Padding="4,2"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </TabItem>

            <!-- Tab 3: Warehouse Stock View (R-013, read-only) -->
            <TabItem Header="🏢 Depo Stokları">
                <DockPanel Margin="16">
                    <TextBlock DockPanel.Dock="Top" Text="Depo Bazında Stok Görünümü (R-013: Multi-Warehouse)" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    <TextBlock DockPanel.Dock="Top" Text="Bu bilgiler salt okunurdur. Stok hareketleri belge girişleri ile değişir." 
                               FontStyle="Italic" Opacity="0.7" Margin="0,0,0,8"/>

                    <DataGrid ItemsSource="{Binding WarehouseStockList}" AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" CanUserDeleteRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Depo" Binding="{Binding WarehouseName}" Width="*"/>
                            <DataGridTextColumn Header="Konum" Binding="{Binding LocationCode}" Width="*"/>
                            <DataGridTextColumn Header="Miktar" Binding="{Binding Quantity, StringFormat='{}{0:N2}'}" Width="100"/>
                            <DataGridTemplateColumn Header="İşlem" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="🗑️ Sil" Command="{Binding DataContext.RemovePriceCmd, RelativeSource={RelativeSource AncestorType=DataGrid}}" 
                                                CommandParameter="{Binding}" Background="#f44336" Foreground="White" Padding="8,4"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </TabItem>

            <!-- Tab 5: Variants & BOM (R-059) -->
            <TabItem Header="🧪 Varyantlar ve Reçete">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="16">
                        <!-- Variants Section -->
                        <GroupBox Header="Ürün Varyantları (R-059: R-014 Backend)" Padding="8" Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Varyant özelliklerini tanımlayın ve kombinasyonları Oluşturun" 
                                           FontStyle="Italic" Opacity="0.7" Margin="0,0,0,8"/>
                                
                                <!-- Attribute Input -->
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="150"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Column="0" Text="Özellik Adı:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBox Grid.Column="1" Text="{Binding NewAttributeName, UpdateSourceTrigger=PropertyChanged}" 
                                             ToolTip="Örn: Renk, Beden" Margin="0,0,16,0"/>
                                    
                                    <TextBlock Grid.Column="2" Text="Değerler:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBox Grid.Column="3" Text="{Binding NewAttributeValues, UpdateSourceTrigger=PropertyChanged}" 
                                             ToolTip="Virgülle ayrılmış (Örn: Kırmızı, Mavi, Yeşil)" Margin="0,0,16,0"/>
                                    
                                    <Button Grid.Column="4" Content="➕ Özellik Ekle" Command="{Binding AddVariantAttributeCmd}" Width="120"/>
                                </Grid>
                                
                                <!-- Attributes List -->
                                <DataGrid ItemsSource="{Binding VariantAttributes}" AutoGenerateColumns="False" 
                                          IsReadOnly="True" CanUserAddRows="False" MaxHeight="150" Margin="0,0,0,8">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Özellik" Binding="{Binding AttributeName}" Width="150"/>
                                        <DataGridTextColumn Header="Değerler" Binding="{Binding Values}" Width="*"/>
                                        <DataGridTemplateColumn Header="İşlem" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="🗑️ Sil" Command="{Binding DataContext.RemoveVariantAttributeCmd, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding}" Padding="4,2"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                                
                                <!-- Generate Button -->
                                <Button Content="🎲 Varyantları Oluştur" Command="{Binding GenerateVariantsCmd}" 
                                        Background="#2196F3" Foreground="White" Padding="16,8" Margin="0,0,0,8" HorizontalAlignment="Left"/>
                                
                                <!-- Generated Variants -->
                                <TextBlock Text="Oluşturulan Varyantlar:" FontWeight="SemiBold" Margin="0,8,0,4"/>
                                <DataGrid ItemsSource="{Binding GeneratedVariants}" AutoGenerateColumns="False" 
                                          IsReadOnly="True" CanUserAddRows="False" MaxHeight="200">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Varyant SKU" Binding="{Binding Code}" Width="*"/>
                                        <DataGridTemplateColumn Header="İşlem" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="🗑️ Sil" Command="{Binding DataContext.RemoveVariantCmd, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding}" Padding="4,2"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </GroupBox>
                        
                        <!-- BOM Section -->
                        <GroupBox Header="Ürün Reçetesi (BOM - Bill of Materials)" Padding="8">
                            <StackPanel>
                                <TextBlock Text="Bu ürünü üretmek için gereken hammaddeleri ve miktarları tanımlayın" 
                                           FontStyle="Italic" Opacity="0.7" Margin="0,0,0,8"/>
                                
                                <!-- Component Search & Add -->
                                <Grid Margin="0,0,0,8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Search Row -->
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Hammadde Ara:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding NewBomComponentSearch, UpdateSourceTrigger=PropertyChanged}" 
                                             ToolTip="SKU veya ürün adı ile ara" Margin="0,0,8,0"/>
                                    <Button Grid.Row="0" Grid.Column="2" Content="🔍 Ara" Command="{Binding SearchComponentCmd}" Width="80" Margin="0,0,16,0"/>
                                    
                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Miktar:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBox Grid.Row="0" Grid.Column="3" Text="{Binding NewBomQtyPer, UpdateSourceTrigger=PropertyChanged}" 
                                             ToolTip="Birim başına miktar" Margin="0,0,8,0"/>
                                    <Button Grid.Row="0" Grid.Column="4" Content="➕ Ekle" Command="{Binding AddBomItemCmd}" Width="80"/>
                                    
                                    <!-- Search Results -->
                                    <ListBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="5" 
                                             ItemsSource="{Binding ComponentSearchResults}" 
                                             MaxHeight="100" Margin="0,8,0,0">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock>
                                                    <TextBlock.InputBindings>
                                                        <MouseBinding Gesture="LeftClick" 
                                                                      Command="{Binding DataContext.SelectComponentCmd, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                      CommandParameter="{Binding}"/>
                                                    </TextBlock.InputBindings>
                                                    <Run Text="{Binding Sku}" FontWeight="Bold"/>
                                                    <Run Text=" - "/>
                                                    <Run Text="{Binding Name}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Grid>
                                
                                <!-- Selected Component Display -->
                                <TextBlock Text="{Binding NewBomComponentName}" FontStyle="Italic" Opacity="0.7" Margin="0,0,0,8"/>
                                
                                <!-- BOM Items List -->
                                <DataGrid ItemsSource="{Binding BomList}" AutoGenerateColumns="False" 
                                          IsReadOnly="True" CanUserAddRows="False" MaxHeight="300">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Hammadde" Binding="{Binding ComponentName}" Width="*"/>
                                        <DataGridTextColumn Header="Birim Başına Miktar" Binding="{Binding QtyPer, StringFormat='{}{0:N2}'}" Width="150"/>
                                        <DataGridTemplateColumn Header="İşlem" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="🗑️ Sil" Command="{Binding DataContext.RemoveBomItemCmd, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding}" Background="#f44336" Foreground="White" Padding="4,2"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </DockPanel>
</Window>
